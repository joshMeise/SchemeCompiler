# test_compiler_let.py - tests compilation of (let ((a e1) (b e2) ...) en) expression
#
# Josh Meise
# 02-05-2026
# Description:
#

from io import BytesIO
import unittest
import sys
import os
from compiler.compiler import *

class LetCompileTests(unittest.TestCase):
    """
    Unit testing framework for the compiling of (let ((a e1) (b e2) ...) en) expressions.
    """

    def _compile(self, expr: list) -> bytes:
        """
        Compiles the provided expression.
        Wrapper around Compile class' compile_function() and write_to_stream() functions.
        Writes compiled code to provided output stream.

        Args:
            expr (list): Expression to be compiled.
        
        Return:
            bytes: Bytes object containing compiled code.
        """
        buf = BytesIO()
        c = Compiler()
        c.compile_function(expr)
        c.write_to_stream(buf)
        return buf.getvalue()

    def test_let_one_binding_normal(self):
        """
        Test (let ((a 5)) a).
        """
        self.assertEqual(self._compile(["let", [("a", 5)], Local("a")]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_one_binding_unused(self):
        """
        Test (let ((a 5)) 3).
        """
        self.assertEqual(self._compile(["let", [("a", 5)], 3]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_two_bindings_first_used(self):
        """
        Test (let ((a 5) (b 3)) a).
        """
        self.assertEqual(self._compile(["let", [("a", 5), ("b", 3)], Local("a")]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_two_bindings_second_used(self):
        """
        Test (let ((a 5) (b 3)) b).
        """
        self.assertEqual(self._compile(["let", [("a", 5), ("b", 3)], Local("b")]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_two_bindings_both_used_plus(self):
        """
        Test (let ((a 5) (b 3)) (+ a b)).
        """
        self.assertEqual(self._compile(["let", [("a", 5), ("b", 3)], ["+", Local("a"), Local("b")]]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_one_binding_expression(self):
        """
        Test (let ((a (+ 4 3))) a).
        """
        self.assertEqual(self._compile(["let", [("a", ["+", 4, 3])], Local("a")]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_one_binding_expression_expression_body(self):
        """
        Test (let ((a (+ 4 3))) (+ 2 a)).
        """
        self.assertEqual(self._compile(["let", [("a", ["+", 4, 3])], ["+", 2, Local("a")]]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_two_bindings_expression_expression_body(self):
        """
        Test (let ((a (+ 4 3)) (b (+ 4 5))) (+ a b)).
        """
        self.assertEqual(self._compile(["let", [("a", ["+", 4, 3]), ("b", ["+", 4, 5])], ["+", Local("a"), Local("b")]]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_many_nested_1(self):
        """
        Test (let ((a (let ((a 5)) a))) (let ((a 6)) a))
        """
        self.assertEqual(self._compile(['let', [('a', ['let', [('a', 5)], Local('a')])], ['let', [('a', 6)], Local('a')]]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_many_nested_2(self):
        """
        test (let ((a 4)) (let ((a (let ((a 5)) a))) (let ((a 6)) a)))
        """
        self.assertEqual(self._compile(['let', [('a', 4)], ['let', [('a', ['let', [('a', 5)], Local('a')])], ['let', [('a', 6)], Local('a')]]]), b"\x01\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00")

    def test_let_unbound_1(self):
        """
        Test (let ((a 4)) (let ((a (let ((a 5)) b))) (let ((a 6)) a)))
        """
        with self.assertRaises(RuntimeError):
            self._compile(['let', [('a', 4)], ['let', [('a', ['let', [('a', 5)], 'b'])], ['let', [('a', 6)], Local('a')]]])

    def test_let_unbound_2(self):
        """
        Test (let ((a 4)) (let ((b 4) (a (let ((a 5)) b))) (let ((a 6)) a)))
        """
        with self.assertRaises(RuntimeError):
            self._compile(['let', [('a', 4)], ['let', [('b', 4), ('a', ['let', [('a', 5)], 'b'])], ['let', [('a', 6)], Local('a')]]])

    def test_let_unbound_3(self):
        """
        Test (let ((a 4)) (let ((b 4) (a (let ((a 5)) b))) (let ((a 6)) b)))
        """
        with self.assertRaises(RuntimeError):
            self._compile(['let', [('a', 4)], ['let', [('b', 4), ('a', ['let', [('a', 5)], 'b'])], ['let', [('a', 6)], Local('b')]]])

if __name__ == '__main__':
    unittest.main()
